name: Update Last Active Time

on:
  schedule:
    - cron: '0 */6 * * *'  # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-time:
    runs-on: ubuntu-latest
    # ê¶Œí•œ ëª…ì‹œì  ì„¤ì •
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
          fetch-depth: 0
        
      - name: Set up timezone
        uses: szenius/set-timezone@v1.2
        with:
          timezoneLinux: "Asia/Seoul"
          
      - name: Update last active time
        run: |
          # í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° (í•œêµ­ ì‹œê°„)
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S KST')
          echo "í˜„ì¬ ì‹œê°„: $CURRENT_TIME"
          
          # ë°±ì—… ìƒì„±
          cp README.md README.md.bak
          
          # README.md íŒŒì¼ ë‚´ìš© í™•ì¸
          echo "README.md íŒŒì¼ ë‚´ìš© í™•ì¸:"
          grep -n "LAST_ACTIVE" README.md || echo "ë§ˆì»¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          
          # ë°©ë²• 1: ë§ˆì»¤ êµì²´ ì‹œë„ (ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ ë³€ê²½)
          if grep -q "<!--LAST_ACTIVE-->" README.md; then
            echo "ë§ˆì»¤ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ êµì²´í•©ë‹ˆë‹¤."
            perl -i -pe "s/<!--LAST_ACTIVE-->/$CURRENT_TIME/g" README.md
            echo "êµì²´ í›„ ë‚´ìš©:"
            grep -A 1 -B 1 "$CURRENT_TIME" README.md || echo "êµì²´ëœ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          # ë°©ë²• 2: 'Last Spell Cast:' íŒ¨í„´ ì°¾ì•„ì„œ êµì²´
          elif grep -q "Last Spell Cast:" README.md; then
            echo "'Last Spell Cast:' íŒ¨í„´ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤. ì´ íŒ¨í„´ì„ ì‚¬ìš©í•˜ì—¬ êµì²´í•©ë‹ˆë‹¤."
            perl -i -pe "s/(Last Spell Cast:).*/$1 $CURRENT_TIME/g" README.md
            echo "êµì²´ í›„ ë‚´ìš©:"
            grep "Last Spell Cast:" README.md
          # ë°©ë²• 3: ì¼ë°˜ì ì¸ 'Last active:' íŒ¨í„´ ì°¾ì•„ì„œ êµì²´
          else
            echo "ì¼ë°˜ì ì¸ 'Last active:' íŒ¨í„´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
            perl -i -pe "s/(Last active:).*/$1 $CURRENT_TIME/g" README.md
            echo "êµì²´ í›„ ë‚´ìš©:"
            grep "Last active:" README.md || echo "'Last active:' íŒ¨í„´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if cmp -s README.md README.md.bak; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            rm README.md.bak
            exit 0
          else
            echo "ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
            git diff README.md
            rm README.md.bak
          fi
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -am "ğŸ¤– ìë™ ì—…ë°ì´íŠ¸: ë§ˆì§€ë§‰ í™œë™ ì‹œê°„ ($(date '+%Y-%m-%d %H:%M:%S KST'))"
          git push
