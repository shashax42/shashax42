name: Update Last Active Time

on:
  schedule:
    - cron: '0 */6 * * *'  # 6시간마다 실행
  workflow_dispatch:  # 수동 실행 가능

jobs:
  update-time:
    runs-on: ubuntu-latest
    # 권한 명시적 설정
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # 전체 히스토리 가져오기
          fetch-depth: 0
        
      - name: Set up timezone
        uses: szenius/set-timezone@v1.2
        with:
          timezoneLinux: "Asia/Seoul"
          
      - name: Update last active time
        run: |
          # 현재 시간 가져오기 (한국 시간)
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S KST')
          echo "현재 시간: $CURRENT_TIME"
          
          # 백업 생성
          cp README.md README.md.bak
          
          # README.md 파일 내용 확인
          echo "README.md 파일 내용 확인:"
          grep -n "LAST_ACTIVE" README.md || echo "마커를 찾을 수 없습니다"
          
          # 방법 1: 마커 교체 시도 (안전한 방법으로 변경)
          if grep -q "<!--LAST_ACTIVE-->" README.md; then
            echo "마커를 찾았습니다. 안전한 방법으로 교체합니다."
            perl -i -pe "s/<!--LAST_ACTIVE-->/$CURRENT_TIME/g" README.md
            echo "교체 후 내용:"
            grep -A 1 -B 1 "$CURRENT_TIME" README.md || echo "교체된 내용을 찾을 수 없습니다."
          # 방법 2: 'Last Spell Cast:' 패턴 찾아서 교체
          elif grep -q "Last Spell Cast:" README.md; then
            echo "'Last Spell Cast:' 패턴을 찾았습니다. 이 패턴을 사용하여 교체합니다."
            perl -i -pe "s/(Last Spell Cast:).*/$1 $CURRENT_TIME/g" README.md
            echo "교체 후 내용:"
            grep "Last Spell Cast:" README.md
          # 방법 3: 일반적인 'Last active:' 패턴 찾아서 교체
          else
            echo "일반적인 'Last active:' 패턴을 사용합니다."
            perl -i -pe "s/(Last active:).*/$1 $CURRENT_TIME/g" README.md
            echo "교체 후 내용:"
            grep "Last active:" README.md || echo "'Last active:' 패턴을 찾을 수 없습니다."
          fi
          
          # 변경사항 확인
          if cmp -s README.md README.md.bak; then
            echo "변경사항이 없습니다."
            rm README.md.bak
            exit 0
          else
            echo "변경사항이 감지되었습니다."
            git diff README.md
            rm README.md.bak
          fi
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -am "🤖 자동 업데이트: 마지막 활동 시간 ($(date '+%Y-%m-%d %H:%M:%S KST'))"
          git push
