name: Update Last Active Time

on:
  schedule:
    - cron: '0 */6 * * *'  # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-time:
    runs-on: ubuntu-latest
    # ê¶Œí•œ ëª…ì‹œì  ì„¤ì •
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
          fetch-depth: 0
        
      - name: Set up timezone
        uses: szenius/set-timezone@v1.2
        with:
          timezoneLinux: "Asia/Seoul"
          
      - name: Update last active time
        run: |
          # í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° (í•œêµ­ ì‹œê°„)
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S KST')
          echo "í˜„ì¬ ì‹œê°„: $CURRENT_TIME"
          
          # README.md íŒŒì¼ ë‚´ìš© í™•ì¸
          echo "README.md íŒŒì¼ ë‚´ìš© í™•ì¸:"
          grep -n "LAST_ACTIVE" README.md || echo "ë§ˆì»¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          
          # íŒŒì¼ ë‚´ìš© ì „ì²´ êµì²´ ëŒ€ì‹  íŠ¹ì • íŒ¨í„´ë§Œ êµì²´
          if grep -q "<!--LAST_ACTIVE-->" README.md; then
            echo "ë§ˆì»¤ ì°¾ìŒ, ì—…ë°ì´íŠ¸ ì¤‘..."
            sed -i "s|<!--LAST_ACTIVE-->|$CURRENT_TIME|g" README.md
            cat README.md | grep -A 1 -B 1 "$CURRENT_TIME"
          else
            echo "ë§ˆì»¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í˜•ì‹ìœ¼ë¡œ ì‹œë„í•©ë‹ˆë‹¤."
            # ë‹¤ë¥¸ íŒ¨í„´ë„ ì‹œë„
            sed -i "s|Last active:.*|Last active: $CURRENT_TIME|g" README.md
          fi
          
          # ë³€ê²½ í™•ì¸ ë° í‘œì‹œ
          git diff README.md
          if [[ -z $(git status --porcelain) ]]; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 0
          else
            echo "ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -am "ğŸ¤– ìë™ ì—…ë°ì´íŠ¸: ë§ˆì§€ë§‰ í™œë™ ì‹œê°„ ($(date '+%Y-%m-%d %H:%M:%S KST'))"
          git push
